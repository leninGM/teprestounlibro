image: registry.michelada.io/products/micheteca:latest

services:
  - postgres

stages:
  - lint
  - test

cache:
  paths:
    - vendor/ruby
    - node_modules

before_script:
  - ruby -v
  - node -v
  - gem install bundler
  - cp config/database.ci.yml config/database.yml
  - bundle install -j $(nproc) --path vendor --full-index --clean
  - bundle exec rake yarn:install
  - bundle exec rake webpacker:compile

build:
  stage: test
  script:
    - bundle exec rake db:create RAILS_ENV=test
    - bundle exec rake db:test:prepare RAILS_ENV=test
    - bundle exec rake test

rubocop:
  stage: lint
  script:
    - bundle exec rubocop
